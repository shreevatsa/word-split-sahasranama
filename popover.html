<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Interactive Śloka Viewer (popover-only)</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
  <main id="app" class="min-h-screen container mx-auto p-4 md:p-8"></main>
  <script src="./data.js"></script>
  <script>
    const colors = ["#3b82f6", "#ef4444", "#10b981", "#f97316", "#8b5cf6", "#d946ef", "#14b8a6", "#f59e0b", "#6366f1", "#ec4899"];
    let idx = 0; // global color index across tokens

    function escapeAttr(s){
      return s.replaceAll('&','&amp;').replaceAll('"','&quot;').replaceAll("'","&#39;");
    }

    function word(display, meaning, n){
      const c = colors[idx++ % colors.length];
      const safeMeaning = escapeAttr(meaning);
      return `<span class="relative inline-block word" data-meaning="${safeMeaning}" data-index="${n}"><span class="font-bold cursor-pointer" style="color:${c}">${display}</span></span>`;
    }

    function installPopovers(){
      document.querySelectorAll('.word').forEach(w => {
        const anchor = w.querySelector('span.font-bold') || w;
        w.addEventListener('click', e => {
          e.stopPropagation();
          const meaning = w.dataset.meaning;
          const index = w.dataset.index;
          let dialog = w._popover;
          if (!dialog){
            dialog = document.createElement('dialog');
            dialog.setAttribute('role','tooltip');
            dialog.setAttribute('popover','');
            dialog.className = 'p-3 rounded-md shadow-lg bg-gray-800 text-white text-sm max-w-[40rem] whitespace-normal break-words';
            document.body.appendChild(dialog);
            w._popover = dialog;
          }
          dialog.textContent = `${meaning} (${index})`;
          dialog.showPopover(anchor);
        });
      });

      document.addEventListener('click', e => {
        document.querySelectorAll('dialog[open]').forEach(d => {
          if (!d.contains(e.target)) d.close();
        });
      });
      document.addEventListener('keydown', e => { if (e.key === 'Escape') document.querySelectorAll('dialog[open]').forEach(d => d.close()); });
    }

    function render(){
      idx = 0;
      const cards = data.map(s => {
        const lines = s.lines.map(line => line.map(part => Array.isArray(part) ? word(part[0], part[1], part[2]) : `<span>${part}</span>`).join('')).join('<br>');
        return `<section class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow rounded-xl p-6 md:p-8 mb-6">\n  <p class="text-2xl md:text-3xl text-gray-700 dark:text-gray-300 font-serif whitespace-pre-line leading-relaxed" lang="sa">${s.dev}</p>\n  <div class="mt-3 text-lg md:text-xl text-gray-600 dark:text-gray-400 font-sans whitespace-pre-wrap leading-relaxed" lang="sa-Latn">${lines}</div>\n</section>`;
      }).join('');
      document.getElementById('app').innerHTML = `\n    <header class="text-center mb-8">\n      <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Everything below is based on the text and translation at https://www.swami-krishnananda.org/vishnu/vishnu_1.html on the website of Swami Krishnananda.</p>\n      <h1 class="text-3xl md:text-4xl font-bold">Interactive Śloka Viewer</h1>\n      <p class="text-gray-600 dark:text-gray-400">Click on colored segments to see their meanings. (Assumes showPopover() is available.)</p>\n    </header>\n    ${cards}\n    <footer class="text-center text-sm text-gray-500 dark:text-gray-400 mt-8"><p>Single-file, Tailwind CDN, auto color cycling</p><p>Source code at &lt;...&gt;</p></footer>`;
      installPopovers();
    }

    document.addEventListener('DOMContentLoaded', render);
  </script>
</body>
</html>
